CREATE DATABASE TECHSHOP
USE TECHSHOP
--2) CREATE TABLES

--CUSTOMERS

CREATE TABLE CUSTOMERS
(
CUSTOMERID INT PRIMARY KEY,
FIRSTNAME VARCHAR(50) NOT NULL,
LASTNAME VARCHAR(50) NOT NULL,
EMAIL VARCHAR(50)NOT NULL,
PHONE VARCHAR(20) UNIQUE,
ADDRESS VARCHAR(50)
);
ALTER TABLE CUSTOMERS ADD TOTALORDERS VARCHAR(50);
--PRODUCTS

CREATE TABLE PRODUCTS
(
PRODUCTID INT PRIMARY KEY,
PRODUCTNAME VARCHAR(50) NOT NULL,
DESCRIPTION VARCHAR(50) NOT NULL,
PRICE FLOAT NOT NULL
);

--ORDERS

CREATE TABLE ORDERS
(
ORDERID INT PRIMARY KEY,
CUSTOMERID INT NOT NULL,
ORDERDATE DATE,
TOTALAMOUNT FLOAT,
FOREIGN KEY(CUSTOMERID) REFERENCES CUSTOMERS(CUSTOMERID) ON DELETE CASCADE
);

--ORDER DETAILS

CREATE TABLE ORDERDETAILS
(
ORDERDETAILID INT PRIMARY KEY,
ORDERID INT NOT NULL,
PRODUCTID INT NOT NULL,
QUANTITY INT NOT NULL,
FOREIGN KEY(ORDERID) REFERENCES ORDERS(ORDERID) ON DELETE CASCADE,
FOREIGN KEY(PRODUCTID) REFERENCES PRODUCTS(PRODUCTID) ON DELETE CASCADE
);

--INVENTORY TABLE

CREATE TABLE INVENTORY
(
INVENTORYID INT PRIMARY KEY,
PRODUCTID INT NOT NULL,
QUANTITYINSTOCK INT NOT NULL,
LASTSTOCKUPDATED INT,
FOREIGN KEY(PRODUCTID) REFERENCES PRODUCTS(PRODUCTID) ON DELETE CASCADE
);


--3A) INSERTING RECORDS TO CUSTOMERS

INSERT INTO CUSTOMERS VALUES(1, 'HARSHA', 'DEEP', 'harsha@gmail.com', '9885712090', 'SR NAGAR, TIRUPATI');
INSERT INTO CUSTOMERS VALUES(2, 'HARSHA', 'p', 'harshap@gmail.com', '9885789090', 'INDRA NAGAR, TIRUPATI');
INSERT INTO CUSTOMERS VALUES(3, 'SYAMSON', 'HARSHADEEP', 'shyam@gmail.com', '9885767898', 'HP LAYOUT, NELLORE');
INSERT INTO CUSTOMERS VALUES(4, 'MAHITHA', 'M', 'mahi@gmail.com', '1122334455', 'NAWABPET, TIRUPATI');
INSERT INTO CUSTOMERS VALUES(5, 'MAHI', 'P', 'MAHITHA@gmail.com', '6677889900', 'NAIDU COLONY, CHITTOOR');
INSERT INTO CUSTOMERS VALUES(6, 'ADITYA', 'SAI', 'adi@gmail.com', '1345267895', 'MK LAYOUT,VIJAYAWADA');
INSERT INTO CUSTOMERS VALUES(7, 'DIVYESH', 'CHINNI', 'duvyesh@gmail.com', '9587125578', 'LL NAGAR, NELLORE');
INSERT INTO CUSTOMERS VALUES(8, 'DHEERAJ', 'P', 'dheeraj@gmail.com', '6300512478', 'PN NAGAR, TIRUPATI');
INSERT INTO CUSTOMERS VALUES(9, 'ARUN', 'KAD', 'arun@gmail.com', '9885456790', 'JP NAGAR, BANGALORE');
INSERT INTO CUSTOMERS VALUES(10,'SUNIL', 'CH', 'ch@gmail.com', '8521478520', 'MP COLONY, VIZAG');
SELECT * FROM CUSTOMERS

-- INSERTING RECORDS TO PRODUCTS

INSERT INTO PRODUCTS VALUES(101, 'PENDRIVE' , 'ELECTRONIC DEVICE' , 360);
INSERT INTO PRODUCTS VALUES(102, 'MOUSE' , 'COMPUTER ACCESSORIES' , 300);
INSERT INTO PRODUCTS VALUES(103, 'KEYBOARD' , 'COMPUTER ACCESSORIES' , 150);
INSERT INTO PRODUCTS VALUES(104, 'MOBILE' , 'ELECTRONIC DEVICE' , 9999);
INSERT INTO PRODUCTS VALUES(105, 'LAPTOP' , 'ELECTRONIC DEVICE' ,49999);
INSERT INTO PRODUCTS VALUES(106, 'COOLER' , 'HOME APPLIANCE' , 4999);
INSERT INTO PRODUCTS VALUES(107, 'FRIDGE' , 'HOME APPLIANCE' , 19999);
INSERT INTO PRODUCTS VALUES(108, 'EARPHONES' , 'GADGET' , 399);
INSERT INTO PRODUCTS VALUES(109, 'TV' , 'HOME APPLIANCE' , 5999);
INSERT INTO PRODUCTS VALUES(110, 'AC' , 'HOME APPLIANCE' , 20000);
SELECT * FROM PRODUCTS

-- INSERTING RECORDS TO ORDERS
INSERT INTO ORDERS VALUES (301, 1, '2023-03-15', 720.50)
INSERT INTO ORDERS VALUES (302, 2, '2022-05-12', 600)
INSERT INTO ORDERS VALUES (303, 3, '2022-09-21', 1000)
INSERT INTO ORDERS VALUES (304, 4, '2022-07-17', 20000)
INSERT INTO ORDERS VALUES (305, 5, '2022-02-18', 49999)
INSERT INTO ORDERS VALUES (306, 6, '2023-10-11', 4999)
INSERT INTO ORDERS VALUES (307, 7, '2022-11-22', 19999)
INSERT INTO ORDERS VALUES (308, 8, '2022-04-24', 1850)
INSERT INTO ORDERS VALUES (309, 9, '2022-03-19', 5999)
INSERT INTO ORDERS VALUES (310, 10, '2023-09-23', 40000)
SELECT * FROM ORDERS

-- INSERTING RECORDS TO ORDER DETAILS
INSERT INTO ORDERDETAILS VALUES(401, 301, 101,1);
INSERT INTO ORDERDETAILS VALUES(402, 302, 103,2);
INSERT INTO ORDERDETAILS VALUES(403, 303, 104,1);
INSERT INTO ORDERDETAILS VALUES(404, 304, 102,1);
INSERT INTO ORDERDETAILS VALUES(405, 305, 109,1);
INSERT INTO ORDERDETAILS VALUES(406, 306, 107,1);
INSERT INTO ORDERDETAILS VALUES(407, 307, 101,1);
INSERT INTO ORDERDETAILS VALUES(408, 308, 101,2);
INSERT INTO ORDERDETAILS VALUES(409, 309, 108,2);
INSERT INTO ORDERDETAILS VALUES(410, 310, 110,1);
SELECT * FROM ORDERDETAILS
UPDATE ORDERDETAILS SET ORDERID=301 WHERE ORDERDETAILID = 401
-- INSERTING RECORDS TO INVENTORY

INSERT INTO INVENTORY VALUES(501, 101, 100, 10);
INSERT INTO INVENTORY VALUES(502, 102, 300, 30);
INSERT INTO INVENTORY VALUES(503, 103, 100, 3);
INSERT INTO INVENTORY VALUES(504, 104, 200, 19);
INSERT INTO INVENTORY VALUES(505, 105, 100, 18);
INSERT INTO INVENTORY VALUES(506, 106, 100, 5);
INSERT INTO INVENTORY VALUES(507, 107, 100, 20);
INSERT INTO INVENTORY VALUES(508, 108, 200, 50);
INSERT INTO INVENTORY VALUES(509, 109, 350, 90);
INSERT INTO INVENTORY VALUES(510, 110, 100, 40);
SELECT * FROM INVENTORY

--3B)
--1
SELECT FIRSTNAME,LASTNAME,EMAIL FROM CUSTOMERS

--2
SELECT ORDERS.ORDERID,ORDERS.ORDERDATE ,CUSTOMERS.FIRSTNAME,CUSTOMERS.LASTNAME
FROM ORDERS 
INNER JOIN CUSTOMERS 
ON ORDERS.CUSTOMERID=CUSTOMERS.CUSTOMERID

--3
INSERT INTO CUSTOMERS VALUES(11,'RAMESH', 'PJ', 'PJ@gmail.com', '9985400322', 'ZP COLONY, TIRUPATI');

--4
UPDATE PRODUCTS SET PRICE = PRICE*1.1 WHERE DESCRIPTION = 'ELECTRONIC DEVICE'

--5
DECLARE @INP INT;
SET @INP = 301
DELETE FROM ORDERS WHERE ORDERID = @INP

--6
INSERT INTO ORDERS VALUES (311, 9, '2021-09-23', 3000)

--7
DECLARE @CUSTOMERID INT = 2;
DECLARE @EMAIL VARCHAR(50) = 'abc@gmail.com';
DECLARE @ADDRESS VARCHAR(50) = 'ABC NAGAR, HYD';

UPDATE CUSTOMERS
SET EMAIL = @EMAIL, ADDRESS = @ADDRESS
WHERE CUSTOMERID = @CUSTOMERID

--8
UPDATE Orders
SET TotalAmount = (
    SELECT SUM(ORDERDETAILS.Quantity * PRODUCTS.Price)
    FROM OrderDetails
    JOIN Products ON ORDERDETAILS.ProductID = PRODUCTS.ProductID
    WHERE ORDERDETAILS.OrderID = ORDERS.OrderID
)

--9
DECLARE @INP INT;
SET @INP = 4
DELETE FROM ORDERS WHERE ORDERID IN (SELECT ORDERID FROM ORDERS WHERE CUSTOMERID = @INP);
DELETE FROM ORDERDETAILS WHERE CUSTOMERID = @INP

---10
INSERT INTO PRODUCTS VALUES(111, 'SMARTWATCH' , 'ELECTRONIC DEVICE' , 999);

---11
DECLARE @ORDERID INT = 308;
DECLARE @UPDATED_DATE DATE = '2020-10-10' ;

UPDATE ORDERS 
SET ORDERDATE = @UPDATED_DATE WHERE ORDERID = @ORDERID

--12
UPDATE CUSTOMERS
SET  TOTALORDERS = (SELECT COUNT(*) FROM ORDERS WHERE ORDERS.CUSTOMERID = CUSTOMERS.CUSTOMERID);

---4) JOINS

---1
SELECT ORDERID, ORDERDATE,CUSTOMERS.FIRSTNAME, CUSTOMERS.LASTNAME
FROM ORDERS 
INNER JOIN CUSTOMERS ON ORDERS.CUSTOMERID = CUSTOMERS.CUSTOMERID;

--2
SELECT PRODUCTNAME, PRICE * QUANTITY AS TOTALREVENUE FROM PRODUCTS
INNER JOIN  ORDERDETAILS ON PRODUCTS.PRODUCTID = ORDERDETAILS.PRODUCTID


--3
SELECT DISTINCT CUSTOMERS.FIRSTNAME, CUSTOMERS.LASTNAME, CUSTOMERS.EMAIL, CUSTOMERS.PHONE
FROM CUSTOMERS
INNER JOIN ORDERS ON CUSTOMERS.CUSTOMERID = ORDERS.CUSTOMERID;

--4
SELECT P.PRODUCTNAME,O.QUANTITY FROM PRODUCTS AS P
INNER JOIN ORDERDETAILS AS O
ON P.PRODUCTID = O.PRODUCTID
ORDER BY 2 DESC
OFFSET 0 ROWS
FETCH NEXT 1 ROWS ONLY

--5
SELECT PRODUCTNAME,DESCRIPTION FROM PRODUCTS  WHERE DESCRIPTION = 'ELECTRONIC DEVICE'
GROUP BY DESCRIPTION,PRODUCTNAME

--6
SELECT CONCAT(C.FIRSTNAME,' ',C.LASTNAME) AS NAME , AVG(O.TOTALAMOUNT) AS AVG
FROM ORDERS O
INNER JOIN CUSTOMERS C
ON C.CUSTOMERID = O.CUSTOMERID
GROUP BY O.CUSTOMERID, C.FIRSTNAME , C.LASTNAME

--7

SELECT O.OrderID, C.FirstName, C.LastName, C.Email, C.Phone, C.Address, SUM(OD.Quantity * P.Price) AS TotalRevenue
FROM Orders AS O
JOIN Customers AS C ON O.CustomerID = C.CustomerID
JOIN OrderDetails AS OD ON O.OrderID = OD.OrderID
JOIN Products AS P ON OD.ProductID = P.ProductID
GROUP BY O.OrderID, C.FirstName, C.LastName, C.Email, C.Phone, C.Address
ORDER BY TotalRevenue DESC
OFFSET 0 ROWS
FETCH NEXT 1 ROWS ONLY

--8
SELECT P.PRODUCTID, P.PRODUCTNAME, COUNT(OD.ORDERDETAILID) AS ORDERCOUNT
FROM PRODUCTS AS P
INNER JOIN ORDERDETAILS AS OD ON P.PRODUCTID = OD.PRODUCTID
GROUP BY P.PRODUCTID, P.PRODUCTNAME
ORDER BY ORDERCOUNT DESC;

--9
DECLARE @PRODUCTNAME VARCHAR(50);
SET @PRODUCTNAME = 'PENDRIVE'

SELECT C.CUSTOMERID, CONCAT(C.FIRSTNAME,' ',C.LASTNAME) AS NAME, O.ORDERID, P.PRODUCTNAME
FROM CUSTOMERS C
INNER JOIN ORDERS O 
ON C.CUSTOMERID = O.CUSTOMERID
INNER JOIN ORDERDETAILS OD ON O.ORDERID = OD.ORDERID
INNER JOIN PRODUCTS P ON OD.PRODUCTID = P.PRODUCTID
WHERE P.PRODUCTNAME = @PRODUCTNAME;

--10
DECLARE @START DATE ;
DECLARE @END DATE ;
SET @START = '2022-05-12' ;
SET @END = '2023-02-03';

SELECT P.PRICE * OD.QUANTITY AS TOTALREVENUE FROM PRODUCTS AS P
INNER JOIN ORDERDETAILS AS OD
ON P.PRODUCTID = OD.PRODUCTID
JOIN ORDERS AS O ON OD.ORDERID = O.ORDERID
WHERE O.ORDERDATE BETWEEN @START AND @END

---5) AGGREGATE FUNCTIONS AND SUBQUERIES
--1
SELECT C.CUSTOMERID, C.FIRSTNAME, C.LASTNAME FROM CUSTOMERS AS C
LEFT JOIN ORDERS AS O ON
C.CUSTOMERID = O.CUSTOMERID
WHERE O.ORDERID IS NULL

--2
SELECT COUNT(PRODUCTID) AS SALE FROM PRODUCTS

--3
SELECT SUM(P.PRICE * OD.QUANTITY) AS TOTALREVENUE FROM PRODUCTS AS P
INNER JOIN ORDERDETAILS AS OD 
ON P.PRODUCTID = OD.PRODUCTID

--4
DECLARE @PRODUCTNAME VARCHAR(20)= 'PENDRIVE'
SELECT AVG(QUANTITY) AS AVERAGEQUANTITY
FROM ORDERDETAILS 
JOIN PRODUCTS ON ORDERDETAILS.PRODUCTID = PRODUCTS.PRODUCTID
WHERE PRODUCTNAME= @PRODUCTNAME

--5
DECLARE @INP INT;
SET @INP = 5
SELECT SUM(OD.Quantity * P.Price) AS TotalRevenue FROM Orders AS O
JOIN OrderDetails AS OD
ON O.OrderID = OD.OrderID
JOIN Products AS P ON 
OD.ProductID = P.ProductID
WHERE O.CustomerID = @INP;

--6
SELECT C.FIRSTNAME,C.LASTNAME , COUNT(ORDERID)AS NOOFORDERS FROM CUSTOMERS AS C
LEFT JOIN ORDERS AS O
ON C.CUSTOMERID = O.ORDERID
GROUP BY C.CUSTOMERID,C.FIRSTNAME,C.LASTNAME
ORDER BY NOOFORDERS DESC;

--7
SELECT SUM(O.QUANTITY) TOTALQUANTITY , P.PRODUCTNAME  
FROM ORDERDETAILS O 
JOIN PRODUCTS P ON O.PRODUCTID=P.PRODUCTID
GROUP BY P.PRODUCTNAME,P.PRODUCTID
ORDER BY TOTALQUANTITY DESC
OFFSET 0 ROWS
FETCH NEXT 1 ROWS ONLY

--8
SELECT C.FIRSTNAME, SUM(O.TOTALAMOUNT)AS TOTALSPENDING FROM CUSTOMERS C 
JOIN ORDERS O ON C.CUSTOMERID=O.CUSTOMERID
GROUP BY C.CUSTOMERID, C.FIRSTNAME
ORDER BY TOTALSPENDING DESC
OFFSET 0 ROWS
FETCH NEXT 1 ROW ONLY

--9
SELECT C.CUSTOMERID ,AVG(P.PRICE*OD.QUANTITY) AS AVERAGEORDERVAL
FROM PRODUCTS AS P 
INNER JOIN ORDERDETAILS AS OD
ON P.PRODUCTID = OD.PRODUCTID
INNER JOIN ORDERS AS O ON O.ORDERID = OD.ORDERID
INNER JOIN CUSTOMERS AS C ON C.CUSTOMERID = O.CUSTOMERID
GROUP BY C.CUSTOMERID


--10
SELECT C.FIRSTNAME,COUNT(O.ORDERID) AS ORDERCOUNT
FROM CUSTOMERS C
LEFT JOIN ORDERS O ON C.CUSTOMERID = O.CUSTOMERID
GROUP BY C.CUSTOMERID, C.FIRSTNAME
ORDER BY ORDERCOUNT DESC;
